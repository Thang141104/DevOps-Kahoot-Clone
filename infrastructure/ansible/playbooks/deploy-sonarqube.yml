---
# ===================================
# SonarQube Deployment Playbook
# Deploy SonarQube to Kubernetes cluster
# ===================================

- name: Deploy SonarQube to Kubernetes
  hosts: k8s_master
  become: yes
  tasks:
    - name: Set vm.max_map_count for SonarQube (ElasticSearch requirement)
      sysctl:
        name: vm.max_map_count
        value: '262144'
        state: present
        sysctl_set: yes
        reload: yes
    
    - name: Verify vm.max_map_count is set
      command: sysctl vm.max_map_count
      register: vm_max_map_count
      changed_when: false
    
    - name: Display vm.max_map_count
      debug:
        msg: "vm.max_map_count is set to {{ vm_max_map_count.stdout }}"
    
    - name: Create sonarqube directory
      file:
        path: /home/ubuntu/sonarqube
        state: directory
        mode: '0755'
      become_user: ubuntu

    - name: Create SonarQube deployment manifest
      copy:
        dest: /home/ubuntu/sonarqube/sonarqube-deployment.yaml
        mode: '0644'
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: sonarqube
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: sonarqube
            namespace: sonarqube
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: sonarqube
            template:
              metadata:
                labels:
                  app: sonarqube
              spec:
                securityContext:
                  fsGroup: 1000
                  fsGroupChangePolicy: OnRootMismatch
                affinity:
                  podAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                    - labelSelector:
                        matchExpressions:
                        - key: app
                          operator: In
                          values:
                          - postgres
                      topologyKey: kubernetes.io/hostname
                initContainers:
                - name: init-sysctl
                  image: busybox:1.36
                  command:
                  - sh
                  - -c
                  - |
                    sysctl -w vm.max_map_count=262144
                    sysctl -w fs.file-max=65536
                  securityContext:
                    privileged: true
                - name: init-permissions
                  image: busybox:1.36
                  command:
                  - sh
                  - -c
                  - |
                    chown -R 1000:1000 /opt/sonarqube/data
                    chown -R 1000:1000 /opt/sonarqube/extensions
                    chown -R 1000:1000 /opt/sonarqube/logs
                    chmod -R 755 /opt/sonarqube/data
                    chmod -R 755 /opt/sonarqube/extensions
                    chmod -R 755 /opt/sonarqube/logs
                  securityContext:
                    runAsUser: 0
                  volumeMounts:
                  - name: sonarqube-data
                    mountPath: /opt/sonarqube/data
                  - name: sonarqube-extensions
                    mountPath: /opt/sonarqube/extensions
                  - name: sonarqube-logs
                    mountPath: /opt/sonarqube/logs
                containers:
                - name: sonarqube
                  image: sonarqube:10-community
                  ports:
                  - containerPort: 9000
                  env:
                  - name: SONAR_JDBC_URL
                    value: "jdbc:postgresql://postgres:5432/sonarqube"
                  - name: SONAR_JDBC_USERNAME
                    value: "sonar"
                  - name: SONAR_JDBC_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: sonarqube-secret
                        key: postgres-password
                  - name: SONAR_ES_BOOTSTRAP_CHECKS_DISABLE
                    value: "true"
                  resources:
                    requests:
                      memory: "2Gi"
                      cpu: "500m"
                    limits:
                      memory: "3Gi"
                      cpu: "1000m"
                  livenessProbe:
                    httpGet:
                      path: /api/system/status
                      port: 9000
                    initialDelaySeconds: 120
                    periodSeconds: 30
                    timeoutSeconds: 10
                    failureThreshold: 6
                  readinessProbe:
                    httpGet:
                      path: /api/system/status
                      port: 9000
                    initialDelaySeconds: 60
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 6
                  volumeMounts:
                  - name: sonarqube-data
                    mountPath: /opt/sonarqube/data
                  - name: sonarqube-extensions
                    mountPath: /opt/sonarqube/extensions
                  - name: sonarqube-logs
                    mountPath: /opt/sonarqube/logs
                volumes:
                - name: sonarqube-data
                  hostPath:
                    path: /data/sonarqube/data
                    type: DirectoryOrCreate
                - name: sonarqube-extensions
                  hostPath:
                    path: /data/sonarqube/extensions
                    type: DirectoryOrCreate
                - name: sonarqube-logs
                  hostPath:
                    path: /data/sonarqube/logs
                    type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: sonarqube
            namespace: sonarqube
          spec:
            type: NodePort
            ports:
            - port: 9000
              targetPort: 9000
              nodePort: 30900
            selector:
              app: sonarqube
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: postgres
            namespace: sonarqube
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: postgres
            template:
              metadata:
                labels:
                  app: postgres
              spec:
                containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                  - containerPort: 5432
                  env:
                  - name: POSTGRES_USER
                    value: "sonar"
                  - name: POSTGRES_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: sonarqube-secret
                        key: postgres-password
                  - name: POSTGRES_DB
                    value: "sonarqube"
                  volumeMounts:
                  - name: postgres-data
                    mountPath: /var/lib/postgresql/data
                volumes:
                - name: postgres-data
                  emptyDir: {}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: postgres
            namespace: sonarqube
          spec:
            ports:
            - port: 5432
              targetPort: 5432
            selector:
              app: postgres
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: sonarqube-secret
            namespace: sonarqube
          type: Opaque
          stringData:
            postgres-password: "sonar123"
            sonar-token: "CHANGE_ME_AFTER_FIRST_LOGIN"

    - name: Check if SonarQube namespace exists
      shell: kubectl get namespace sonarqube
      register: sonarqube_namespace
      ignore_errors: yes
      become_user: ubuntu

    - name: Deploy SonarQube
      shell: kubectl apply -f /home/ubuntu/sonarqube/sonarqube-deployment.yaml
      register: sonarqube_deploy
      become_user: ubuntu

    - name: Wait for PostgreSQL to be ready (2-3 minutes)
      shell: kubectl wait --for=condition=ready --timeout=300s pod -l app=postgres -n sonarqube
      retries: 2
      delay: 30
      register: postgres_ready
      until: postgres_ready.rc == 0
      become_user: ubuntu
      ignore_errors: yes

    - name: Wait for SonarQube to be ready (5-10 minutes)
      shell: kubectl wait --for=condition=ready --timeout=600s pod -l app=sonarqube -n sonarqube
      retries: 3
      delay: 60
      register: sonarqube_ready
      until: sonarqube_ready.rc == 0
      become_user: ubuntu
      ignore_errors: yes

    - name: Get SonarQube service cluster IP
      shell: kubectl get svc -n sonarqube sonarqube -o jsonpath='{.spec.clusterIP}'
      register: sonarqube_clusterip
      become_user: ubuntu
      when: sonarqube_ready is succeeded

    - name: Get SonarQube NodePort
      shell: kubectl get svc -n sonarqube sonarqube -o jsonpath='{.spec.ports[0].nodePort}'
      become_user: ubuntu
      register: sonarqube_nodeport
      when: sonarqube_ready is succeeded

    - name: Display SonarQube deployment info
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "âœ… SonarQube Deployed Successfully!"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ“ Access URLs:"
          - "   Internal (from Jenkins): http://sonarqube.sonarqube.svc.cluster.local:9000"
          - "   Cluster IP: http://{{ sonarqube_clusterip.stdout }}:9000"
          - "   External (NodePort): http://{{ ansible_host }}:{{ sonarqube_nodeport.stdout }}"
          - ""
          - "ğŸ‘¤ Default Credentials:"
          - "   Username: admin"
          - "   Password: admin"
          - "   âš ï¸  IMPORTANT: Change password on first login!"
          - ""
          - "ğŸ”§ Access from your machine:"
          - "   Option 1 - Port Forward:"
          - "     kubectl --kubeconfig=<path> port-forward -n sonarqube svc/sonarqube 9000:9000"
          - "     Then open: http://localhost:9000"
          - ""
          - "   Option 2 - Direct NodePort:"
          - "     http://{{ ansible_host }}:{{ sonarqube_nodeport.stdout }}"
          - ""
          - "ğŸ¯ Next Steps for Jenkins Integration:"
          - "   1. Access SonarQube UI (use any method above)"
          - "   2. Login with admin/admin and change password"
          - "   3. Go to: My Account â†’ Security â†’ Generate Token"
          - "   4. Token Name: jenkins-token"
          - "   5. Copy the generated token"
          - "   6. In Jenkins: Manage Jenkins â†’ Credentials â†’ Add"
          - "      - Kind: Secret text"
          - "      - Secret: <paste token>"
          - "      - ID: sonarqube-token"
          - "   7. Uncomment SONAR_TOKEN line in Jenkinsfile (line 26)"
          - ""
          - "ğŸ“ Verify deployment:"
          - "   kubectl get pods -n sonarqube"
          - "   kubectl logs -n sonarqube -l app=sonarqube"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      when: sonarqube_ready is succeeded

    - name: Display troubleshooting info
      debug:
        msg:
          - "âš ï¸  SonarQube deployment may still be initializing..."
          - "Check status with: kubectl get pods -n sonarqube -w"
          - "Check logs: kubectl logs -n sonarqube -l app=sonarqube -f"
      when: sonarqube_ready is failed
