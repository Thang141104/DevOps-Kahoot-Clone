---
# ===================================
# SonarQube Deployment Playbook (WORKER NODES)
# SonarQube 10.x + PostgreSQL
# ===================================

- name: Deploy SonarQube to Kubernetes
  hosts: k8s_master
  become: yes
  tasks:

    # --------------------------------------------------
    # Kernel requirements (ElasticSearch) - Apply on ALL nodes
    # --------------------------------------------------
    - name: Ensure vm.max_map_count is set
      sysctl:
        name: vm.max_map_count
        value: '262144'
        state: present
        sysctl_set: yes
        reload: yes
      delegate_to: "{{ item }}"
      with_items:
        - 34.200.233.56
        - 44.198.175.214
      ignore_errors: yes

    - name: Verify vm.max_map_count
      command: sysctl vm.max_map_count
      register: vm_max_map_count
      changed_when: false

    - name: Show vm.max_map_count
      debug:
        msg: "vm.max_map_count = {{ vm_max_map_count.stdout }}"

    # --------------------------------------------------
    # Workspace
    # --------------------------------------------------
    - name: Create sonarqube workspace
      file:
        path: /home/ubuntu/sonarqube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    # --------------------------------------------------
    # Kubernetes Manifest
    # --------------------------------------------------
    - name: Create SonarQube manifest
      copy:
        dest: /home/ubuntu/sonarqube/sonarqube.yaml
        mode: '0644'
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: sonarqube
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: sonarqube-secret
            namespace: sonarqube
          type: Opaque
          stringData:
            postgres-password: "sonar123"
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: postgres
            namespace: sonarqube
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: postgres
            template:
              metadata:
                labels:
                  app: postgres
              spec:
                # Schedule on worker nodes ONLY (not master)
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: node-role.kubernetes.io/control-plane
                          operator: DoesNotExist
                  
                containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                  - containerPort: 5432
                  env:
                  - name: POSTGRES_USER
                    value: sonar
                  - name: POSTGRES_DB
                    value: sonarqube
                  - name: POSTGRES_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: sonarqube-secret
                        key: postgres-password
                  readinessProbe:
                    exec:
                      command:
                      - sh
                      - -c
                      - pg_isready -U sonar -d sonarqube
                    initialDelaySeconds: 10
                    periodSeconds: 5
                  volumeMounts:
                  - name: postgres-data
                    mountPath: /var/lib/postgresql/data
                volumes:
                - name: postgres-data
                  hostPath:
                    path: /data/postgres
                    type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: postgres
            namespace: sonarqube
          spec:
            ports:
            - port: 5432
              targetPort: 5432
            selector:
              app: postgres
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: sonarqube
            namespace: sonarqube
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: sonarqube
            template:
              metadata:
                labels:
                  app: sonarqube
              spec:
                # Schedule on worker nodes, same node as PostgreSQL
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: node-role.kubernetes.io/control-plane
                          operator: DoesNotExist
                  podAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                    - labelSelector:
                        matchExpressions:
                        - key: app
                          operator: In
                          values:
                          - postgres
                      topologyKey: kubernetes.io/hostname
                  
                securityContext:
                  fsGroup: 1000

                initContainers:
                - name: wait-for-postgres
                  image: postgres:15-alpine
                  env:
                  - name: PGPASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: sonarqube-secret
                        key: postgres-password
                  command:
                  - sh
                  - -c
                  - |
                    echo "Waiting for PostgreSQL..."
                    echo "Using Kubernetes service discovery env vars..."
                    
                    # Use K8s auto-injected environment variable
                    POSTGRES_HOST="${POSTGRES_PORT_5432_TCP_ADDR:-postgres}"
                    echo "Target: $POSTGRES_HOST:5432"
                    
                    max_attempts=60
                    attempt=0
                    
                    until pg_isready -h "$POSTGRES_HOST" -p 5432 -U sonar -d sonarqube; do
                      attempt=$((attempt+1))
                      if [ $attempt -ge $max_attempts ]; then
                        echo "Failed to connect after $max_attempts attempts"
                        echo "Env vars available:"
                        env | grep POSTGRES || echo "No POSTGRES env vars"
                        exit 1
                      fi
                      echo "Attempt $attempt/$max_attempts - waiting 5s..."
                      sleep 5
                    done
                    echo "PostgreSQL is ready at $POSTGRES_HOST!"

                - name: init-permissions
                  image: busybox:1.36
                  command:
                  - sh
                  - -c
                  - |
                    chown -R 1000:1000 /opt/sonarqube
                  securityContext:
                    runAsUser: 0
                  volumeMounts:
                  - name: sonarqube-data
                    mountPath: /opt/sonarqube/data
                  - name: sonarqube-extensions
                    mountPath: /opt/sonarqube/extensions
                  - name: sonarqube-logs
                    mountPath: /opt/sonarqube/logs

                containers:
                - name: sonarqube
                  image: sonarqube:10.4.1-community
                  ports:
                  - containerPort: 9000
                  env:
                  - name: SONAR_JDBC_URL
                    value: jdbc:postgresql://postgres:5432/sonarqube
                  - name: SONAR_JDBC_USERNAME
                    value: sonar
                  - name: SONAR_JDBC_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: sonarqube-secret
                        key: postgres-password
                  - name: SONAR_JDBC_MAXWAIT
                    value: "300"
                  resources:
                    requests:
                      memory: "3Gi"
                      cpu: "500m"
                    limits:
                      memory: "4Gi"
                      cpu: "1000m"
                  readinessProbe:
                    httpGet:
                      path: /api/system/status
                      port: 9000
                    initialDelaySeconds: 120
                    periodSeconds: 15
                    failureThreshold: 10
                  livenessProbe:
                    httpGet:
                      path: /api/system/status
                      port: 9000
                    initialDelaySeconds: 180
                    periodSeconds: 30
                    failureThreshold: 10
                  volumeMounts:
                  - name: sonarqube-data
                    mountPath: /opt/sonarqube/data
                  - name: sonarqube-extensions
                    mountPath: /opt/sonarqube/extensions
                  - name: sonarqube-logs
                    mountPath: /opt/sonarqube/logs

                volumes:
                - name: sonarqube-data
                  hostPath:
                    path: /data/sonarqube/data
                    type: DirectoryOrCreate
                - name: sonarqube-extensions
                  hostPath:
                    path: /data/sonarqube/extensions
                    type: DirectoryOrCreate
                - name: sonarqube-logs
                  hostPath:
                    path: /data/sonarqube/logs
                    type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: sonarqube
            namespace: sonarqube
          spec:
            type: NodePort
            selector:
              app: sonarqube
            ports:
            - port: 9000
              targetPort: 9000
              nodePort: 30900

    # --------------------------------------------------
    # Clean up existing deployment
    # --------------------------------------------------
    - name: Delete existing SonarQube deployment
      shell: kubectl delete -f /home/ubuntu/sonarqube/sonarqube.yaml --ignore-not-found=true
      become_user: ubuntu
      ignore_errors: yes

    - name: Wait for cleanup
      pause:
        seconds: 10

    # --------------------------------------------------
    # Deploy
    # --------------------------------------------------
    - name: Apply SonarQube manifest
      shell: kubectl apply -f /home/ubuntu/sonarqube/sonarqube.yaml
      become_user: ubuntu

    - name: Wait for PostgreSQL
      shell: kubectl wait --for=condition=ready pod -l app=postgres -n sonarqube --timeout=300s
      become_user: ubuntu

    - name: Wait for SonarQube
      shell: kubectl wait --for=condition=ready pod -l app=sonarqube -n sonarqube --timeout=600s
      become_user: ubuntu
      ignore_errors: yes

    - name: Show pod status
      shell: kubectl get pods -n sonarqube -o wide
      become_user: ubuntu
      register: pod_status

    - name: Display pods
      debug:
        msg: "{{ pod_status.stdout_lines }}"