---
- name: Deploy Prometheus and Grafana Monitoring Stack
  hosts: master
  become: yes
  vars:
    k8s_manifests_dir: "/home/ubuntu/kahoot-monitoring"
    monitoring_namespace: "monitoring"
    prometheus_version: "v2.48.0"
    grafana_version: "10.2.3"
    
  tasks:
    - name: Create monitoring manifests directory
      file:
        path: "{{ k8s_manifests_dir }}"
        state: directory
        mode: '0755'
        owner: ubuntu
        group: ubuntu

    - name: Create monitoring namespace manifest
      copy:
        dest: "{{ k8s_manifests_dir }}/namespace.yaml"
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: {{ monitoring_namespace }}
            labels:
              name: monitoring
        mode: '0644'

    - name: Create Prometheus ConfigMap
      copy:
        dest: "{{ k8s_manifests_dir }}/prometheus-config.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: {{ monitoring_namespace }}
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
                external_labels:
                  cluster: 'kahoot-cluster'
                  environment: 'production'
              
              scrape_configs:
                # Prometheus self-monitoring
                - job_name: 'prometheus'
                  static_configs:
                    - targets: ['localhost:9090']
                
                # Kubernetes API Server
                - job_name: 'kubernetes-apiservers'
                  kubernetes_sd_configs:
                    - role: endpoints
                  scheme: https
                  tls_config:
                    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                      action: keep
                      regex: default;kubernetes;https
                
                # Kubernetes Nodes
                - job_name: 'kubernetes-nodes'
                  kubernetes_sd_configs:
                    - role: node
                  scheme: https
                  tls_config:
                    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
                  relabel_configs:
                    - action: labelmap
                      regex: __meta_kubernetes_node_label_(.+)
                
                # Kubernetes Pods
                - job_name: 'kubernetes-pods'
                  kubernetes_sd_configs:
                    - role: pod
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                      action: keep
                      regex: true
                    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                      action: replace
                      target_label: __metrics_path__
                      regex: (.+)
                    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                      action: replace
                      regex: ([^:]+)(?::\d+)?;(\d+)
                      replacement: $1:$2
                      target_label: __address__
                    - action: labelmap
                      regex: __meta_kubernetes_pod_label_(.+)
                    - source_labels: [__meta_kubernetes_namespace]
                      action: replace
                      target_label: kubernetes_namespace
                    - source_labels: [__meta_kubernetes_pod_name]
                      action: replace
                      target_label: kubernetes_pod_name
                
                # Kubernetes Services
                - job_name: 'kubernetes-services'
                  kubernetes_sd_configs:
                    - role: service
                  metrics_path: /metrics
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
                      action: keep
                      regex: true
                    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
                      action: replace
                      target_label: __metrics_path__
                      regex: (.+)
                    - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
                      action: replace
                      target_label: __address__
                      regex: ([^:]+)(?::\d+)?;(\d+)
                      replacement: $1:$2
                    - action: labelmap
                      regex: __meta_kubernetes_service_label_(.+)
                    - source_labels: [__meta_kubernetes_namespace]
                      action: replace
                      target_label: kubernetes_namespace
                    - source_labels: [__meta_kubernetes_service_name]
                      action: replace
                      target_label: kubernetes_service_name
        mode: '0644'

    - name: Create Prometheus RBAC
      copy:
        dest: "{{ k8s_manifests_dir }}/prometheus-rbac.yaml"
        content: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: prometheus
            namespace: {{ monitoring_namespace }}
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: prometheus
          rules:
            - apiGroups: [""]
              resources:
                - nodes
                - nodes/proxy
                - services
                - endpoints
                - pods
              verbs: ["get", "list", "watch"]
            - apiGroups:
                - extensions
              resources:
                - ingresses
              verbs: ["get", "list", "watch"]
            - nonResourceURLs: ["/metrics"]
              verbs: ["get"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: prometheus
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: prometheus
          subjects:
            - kind: ServiceAccount
              name: prometheus
              namespace: {{ monitoring_namespace }}
        mode: '0644'

    - name: Create Prometheus Deployment
      copy:
        dest: "{{ k8s_manifests_dir }}/prometheus-deployment.yaml"
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: {{ monitoring_namespace }}
            labels:
              app: prometheus
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                serviceAccountName: prometheus
                containers:
                  - name: prometheus
                    image: prom/prometheus:{{ prometheus_version }}
                    args:
                      - '--config.file=/etc/prometheus/prometheus.yml'
                      - '--storage.tsdb.path=/prometheus'
                      - '--storage.tsdb.retention.time=15d'
                      - '--web.console.libraries=/etc/prometheus/console_libraries'
                      - '--web.console.templates=/etc/prometheus/consoles'
                      - '--web.enable-lifecycle'
                    ports:
                      - containerPort: 9090
                        name: web
                    volumeMounts:
                      - name: config
                        mountPath: /etc/prometheus
                      - name: storage
                        mountPath: /prometheus
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                    livenessProbe:
                      httpGet:
                        path: /-/healthy
                        port: 9090
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /-/ready
                        port: 9090
                      initialDelaySeconds: 10
                      periodSeconds: 5
                volumes:
                  - name: config
                    configMap:
                      name: prometheus-config
                  - name: storage
                    emptyDir: {}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: {{ monitoring_namespace }}
            labels:
              app: prometheus
          spec:
            type: NodePort
            ports:
              - port: 9090
                targetPort: 9090
                nodePort: 30909
                protocol: TCP
                name: web
            selector:
              app: prometheus
        mode: '0644'

    - name: Create Grafana ConfigMaps
      copy:
        dest: "{{ k8s_manifests_dir }}/grafana-config.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-datasources
            namespace: {{ monitoring_namespace }}
          data:
            datasources.yaml: |
              apiVersion: 1
              datasources:
                - name: Prometheus
                  type: prometheus
                  access: proxy
                  url: http://prometheus:9090
                  isDefault: true
                  editable: true
          ---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboards-provider
            namespace: {{ monitoring_namespace }}
          data:
            dashboards.yaml: |
              apiVersion: 1
              providers:
                - name: 'default'
                  orgId: 1
                  folder: ''
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards
          ---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-cluster
            namespace: {{ monitoring_namespace }}
          data:
            kubernetes-cluster.json: |
              {
                "dashboard": {
                  "title": "Kubernetes Cluster Monitoring",
                  "tags": ["kubernetes", "cluster"],
                  "timezone": "browser",
                  "panels": [
                    {
                      "title": "Cluster CPU Usage",
                      "type": "graph",
                      "targets": [
                        {
                          "expr": "sum(rate(container_cpu_usage_seconds_total[5m]))",
                          "legendFormat": "CPU Usage"
                        }
                      ]
                    },
                    {
                      "title": "Cluster Memory Usage",
                      "type": "graph",
                      "targets": [
                        {
                          "expr": "sum(container_memory_usage_bytes)",
                          "legendFormat": "Memory Usage"
                        }
                      ]
                    },
                    {
                      "title": "Pod Status",
                      "type": "stat",
                      "targets": [
                        {
                          "expr": "count(kube_pod_info)",
                          "legendFormat": "Total Pods"
                        }
                      ]
                    }
                  ]
                }
              }
        mode: '0644'

    - name: Create Grafana Deployment
      copy:
        dest: "{{ k8s_manifests_dir }}/grafana-deployment.yaml"
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: {{ monitoring_namespace }}
            labels:
              app: grafana
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                  - name: grafana
                    image: grafana/grafana:{{ grafana_version }}
                    ports:
                      - containerPort: 3000
                        name: http
                    env:
                      - name: GF_SECURITY_ADMIN_USER
                        value: "admin"
                      - name: GF_SECURITY_ADMIN_PASSWORD
                        value: "Kahoot@2025"
                      - name: GF_INSTALL_PLUGINS
                        value: ""
                    volumeMounts:
                      - name: grafana-storage
                        mountPath: /var/lib/grafana
                      - name: grafana-datasources
                        mountPath: /etc/grafana/provisioning/datasources
                      - name: grafana-dashboards-provider
                        mountPath: /etc/grafana/provisioning/dashboards
                      - name: grafana-dashboard-cluster
                        mountPath: /var/lib/grafana/dashboards
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "200m"
                    livenessProbe:
                      httpGet:
                        path: /api/health
                        port: 3000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /api/health
                        port: 3000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                volumes:
                  - name: grafana-storage
                    emptyDir: {}
                  - name: grafana-datasources
                    configMap:
                      name: grafana-datasources
                  - name: grafana-dashboards-provider
                    configMap:
                      name: grafana-dashboards-provider
                  - name: grafana-dashboard-cluster
                    configMap:
                      name: grafana-dashboard-cluster
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: {{ monitoring_namespace }}
            labels:
              app: grafana
          spec:
            type: NodePort
            ports:
              - port: 3000
                targetPort: 3000
                nodePort: 30300
                protocol: TCP
                name: http
            selector:
              app: grafana
        mode: '0644'

    - name: Apply monitoring namespace
      shell: kubectl apply -f {{ k8s_manifests_dir }}/namespace.yaml
      become_user: ubuntu

    - name: Apply Prometheus RBAC
      shell: kubectl apply -f {{ k8s_manifests_dir }}/prometheus-rbac.yaml
      become_user: ubuntu

    - name: Apply Prometheus ConfigMap
      shell: kubectl apply -f {{ k8s_manifests_dir }}/prometheus-config.yaml
      become_user: ubuntu

    - name: Apply Prometheus Deployment
      shell: kubectl apply -f {{ k8s_manifests_dir }}/prometheus-deployment.yaml
      become_user: ubuntu

    - name: Apply Grafana ConfigMaps
      shell: kubectl apply -f {{ k8s_manifests_dir }}/grafana-config.yaml
      become_user: ubuntu

    - name: Apply Grafana Deployment
      shell: kubectl apply -f {{ k8s_manifests_dir }}/grafana-deployment.yaml
      become_user: ubuntu

    - name: Wait for Prometheus to be ready
      shell: kubectl wait --for=condition=available --timeout=300s deployment/prometheus -n {{ monitoring_namespace }}
      become_user: ubuntu

    - name: Wait for Grafana to be ready
      shell: kubectl wait --for=condition=available --timeout=300s deployment/grafana -n {{ monitoring_namespace }}
      become_user: ubuntu

    - name: Get Prometheus pod status
      shell: kubectl get pods -n {{ monitoring_namespace }} -l app=prometheus
      become_user: ubuntu
      register: prometheus_pods

    - name: Get Grafana pod status
      shell: kubectl get pods -n {{ monitoring_namespace }} -l app=grafana
      become_user: ubuntu
      register: grafana_pods

    - name: Display monitoring stack status
      debug:
        msg:
          - "============================================"
          - "Monitoring Stack Deployed Successfully!"
          - "============================================"
          - "Prometheus Pods:"
          - "{{ prometheus_pods.stdout }}"
          - ""
          - "Grafana Pods:"
          - "{{ grafana_pods.stdout }}"
          - ""
          - "Access URLs:"
          - "Prometheus: http://{{ ansible_host }}:30909"
          - "Grafana: http://{{ ansible_host }}:30300"
          - "  Username: admin"
          - "  Password: Kahoot@2025"
          - "============================================"

    - name: Create monitoring info file
      copy:
        dest: "/home/ubuntu/monitoring-info.txt"
        content: |
          ============================================
          Kahoot Clone - Monitoring Stack
          ============================================
          
          Prometheus:
            URL: http://{{ ansible_host }}:30909
            Metrics Retention: 15 days
            Scrape Interval: 15s
          
          Grafana:
            URL: http://{{ ansible_host }}:30300
            Username: admin
            Password: Kahoot@2025
          
          Useful Commands:
            # View Prometheus logs
            kubectl logs -n monitoring -l app=prometheus --tail=100
            
            # View Grafana logs
            kubectl logs -n monitoring -l app=grafana --tail=100
            
            # Check all monitoring resources
            kubectl get all -n monitoring
            
            # Delete monitoring stack
            kubectl delete namespace monitoring
          
          ============================================
        owner: ubuntu
        group: ubuntu
        mode: '0644'
