# ============================================
# Jenkins Role - Main Tasks
# ============================================
---
- name: Install Java 17
  apt:
    name: openjdk-17-jdk
    state: present
    update_cache: yes
  become: yes

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes

- name: Download Jenkins GPG key
  get_url:
    url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
    dest: /tmp/jenkins.key
    mode: '0644'
    timeout: 60
  retries: 3
  delay: 5

- name: Add Jenkins GPG key
  shell: |
    cat /tmp/jenkins.key | gpg --dearmor -o /etc/apt/keyrings/jenkins.gpg
  args:
    creates: /etc/apt/keyrings/jenkins.gpg
  become: yes

- name: Add Jenkins repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/jenkins.gpg] https://pkg.jenkins.io/debian-stable binary/"
    state: present
  become: yes

- name: Install Jenkins
  apt:
    name: jenkins
    state: present
    update_cache: yes
  become: yes

- name: Install Node.js
  include_tasks: nodejs.yml

- name: Install AWS CLI
  include_tasks: awscli.yml

- name: Install kubectl
  include_tasks: kubectl.yml

- name: Install Trivy
  include_tasks: trivy.yml

- name: Install SonarQube Scanner
  include_tasks: sonar-scanner.yml

- name: Create Jenkins .kube directory
  file:
    path: /var/lib/jenkins/.kube
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'
  become: yes

- name: Create Jenkins scripts directory
  file:
    path: /var/lib/jenkins/scripts
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'
  become: yes

- name: Configure Jenkins systemd service
  template:
    src: jenkins.service.j2
    dest: /etc/systemd/system/jenkins.service
    mode: '0644'
  become: yes
  notify: restart jenkins

- name: Enable and start Jenkins
  systemd:
    name: jenkins
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes

- name: Wait for Jenkins to start
  wait_for:
    port: 8080
    delay: 10
    timeout: 300

- name: Get Jenkins initial password
  slurp:
    src: /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_initial_password
  become: yes
  ignore_errors: yes

- name: Display Jenkins initial password
  debug:
    msg: "Jenkins initial password: {{ jenkins_initial_password.content | b64decode }}"
  when: jenkins_initial_password is succeeded

- name: Install Jenkins plugins
  include_tasks: plugins.yml
- name: Setup Nx for Jenkins
  include_tasks: nx.yml