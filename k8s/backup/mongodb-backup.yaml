apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-backup-script
  namespace: kahoot-app
data:
  backup.sh: |
    #!/bin/bash
    set -e
    
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_DIR="/backup"
    BACKUP_NAME="kahoot_backup_${TIMESTAMP}"
    BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"
    
    echo "üîÑ Starting MongoDB backup at $(date)"
    echo "üìÅ Backup location: ${BACKUP_PATH}"
    
    # Create backup directory
    mkdir -p ${BACKUP_DIR}
    
    # Perform backup using mongodump
    mongodump \
      --host=${MONGO_HOST:-mongodb} \
      --port=${MONGO_PORT:-27017} \
      --username=${MONGO_USER} \
      --password=${MONGO_PASSWORD} \
      --authenticationDatabase=admin \
      --out=${BACKUP_PATH}
    
    # Compress backup
    echo "üì¶ Compressing backup..."
    tar -czf "${BACKUP_PATH}.tar.gz" -C ${BACKUP_DIR} ${BACKUP_NAME}
    rm -rf ${BACKUP_PATH}
    
    # Keep only last 7 backups
    echo "üßπ Cleaning old backups (keeping last 7)..."
    ls -t ${BACKUP_DIR}/kahoot_backup_*.tar.gz | tail -n +8 | xargs -r rm
    
    # Upload to S3 (optional, if configured)
    if [ -n "${AWS_S3_BUCKET}" ]; then
      echo "‚òÅÔ∏è  Uploading to S3..."
      aws s3 cp "${BACKUP_PATH}.tar.gz" "s3://${AWS_S3_BUCKET}/backups/"
    fi
    
    echo "‚úÖ Backup completed successfully!"
    echo "üìä Backup size: $(du -h ${BACKUP_PATH}.tar.gz | cut -f1)"

  restore.sh: |
    #!/bin/bash
    set -e
    
    if [ -z "$1" ]; then
      echo "Usage: $0 <backup_file>"
      echo "Available backups:"
      ls -lh /backup/*.tar.gz
      exit 1
    fi
    
    BACKUP_FILE=$1
    RESTORE_DIR="/restore_tmp"
    
    echo "üîÑ Starting MongoDB restore from ${BACKUP_FILE}"
    
    # Extract backup
    mkdir -p ${RESTORE_DIR}
    tar -xzf ${BACKUP_FILE} -C ${RESTORE_DIR}
    
    # Find the extracted directory
    EXTRACTED_DIR=$(ls -d ${RESTORE_DIR}/kahoot_backup_* | head -1)
    
    # Perform restore
    mongorestore \
      --host=${MONGO_HOST:-mongodb} \
      --port=${MONGO_PORT:-27017} \
      --username=${MONGO_USER} \
      --password=${MONGO_PASSWORD} \
      --authenticationDatabase=admin \
      --drop \
      ${EXTRACTED_DIR}
    
    # Cleanup
    rm -rf ${RESTORE_DIR}
    
    echo "‚úÖ Restore completed successfully!"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongodb-backup-pvc
  namespace: kahoot-app
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi  # Adjust based on your database size

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: kahoot-app
spec:
  # Daily at 2 AM
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: mongodb-backup
              image: mongo:7.0
              command: ["/bin/bash", "/scripts/backup.sh"]
              env:
                - name: MONGO_HOST
                  value: "mongodb"
                - name: MONGO_PORT
                  value: "27017"
                - name: MONGO_USER
                  valueFrom:
                    secretKeyRef:
                      name: mongodb-secret
                      key: username
                - name: MONGO_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: mongodb-secret
                      key: password
                # Optional: AWS S3 for off-site backups
                # - name: AWS_S3_BUCKET
                #   value: "your-backup-bucket"
                # - name: AWS_ACCESS_KEY_ID
                #   valueFrom:
                #     secretKeyRef:
                #       name: aws-credentials
                #       key: access-key-id
                # - name: AWS_SECRET_ACCESS_KEY
                #   valueFrom:
                #     secretKeyRef:
                #       name: aws-credentials
                #       key: secret-access-key
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
                - name: backup-scripts
                  mountPath: /scripts
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
          restartPolicy: OnFailure
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: mongodb-backup-pvc
            - name: backup-scripts
              configMap:
                name: mongodb-backup-script
                defaultMode: 0755

---
# Manual backup job (can be triggered on-demand)
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-manual-backup
  namespace: kahoot-app
spec:
  template:
    spec:
      containers:
        - name: mongodb-backup
          image: mongo:7.0
          command: ["/bin/bash", "/scripts/backup.sh"]
          env:
            - name: MONGO_HOST
              value: "mongodb"
            - name: MONGO_PORT
              value: "27017"
            - name: MONGO_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: username
            - name: MONGO_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: password
          volumeMounts:
            - name: backup-storage
              mountPath: /backup
            - name: backup-scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      restartPolicy: Never
      volumes:
        - name: backup-storage
          persistentVolumeClaim:
            claimName: mongodb-backup-pvc
        - name: backup-scripts
          configMap:
            name: mongodb-backup-script
            defaultMode: 0755
  backoffLimit: 3
