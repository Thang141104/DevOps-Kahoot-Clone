---
- name: Deploy Application to Kubernetes
  hosts: k8s_master
  become_user: ubuntu
  
  vars:
    namespace: default
    ecr_registry: "{{ lookup('env', 'ECR_REGISTRY') }}"
    build_version: "{{ lookup('env', 'BUILD_VERSION') | default('latest', true) }}"
    
  tasks:
    - name: Create namespace if not exists
      command: kubectl create namespace {{ namespace }} --dry-run=client -o yaml
      register: namespace_yaml
    
    - name: Apply namespace
      shell: echo "{{ namespace_yaml.stdout }}" | kubectl apply -f -
    
    - name: Deploy MongoDB secret
      command: kubectl apply -f /home/ubuntu/k8s/secrets.yaml -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy SonarQube
      command: kubectl apply -f /home/ubuntu/k8s/sonarqube-deployment.yaml
      ignore_errors: yes
    
    - name: Deploy Gateway
      command: >
        kubectl set image deployment/gateway
        gateway={{ ecr_registry }}/kahoot-clone-gateway:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy Auth Service
      command: >
        kubectl set image deployment/auth
        auth={{ ecr_registry }}/kahoot-clone-auth:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy User Service
      command: >
        kubectl set image deployment/user
        user={{ ecr_registry }}/kahoot-clone-user:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy Quiz Service
      command: >
        kubectl set image deployment/quiz
        quiz={{ ecr_registry }}/kahoot-clone-quiz:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy Game Service
      command: >
        kubectl set image deployment/game
        game={{ ecr_registry }}/kahoot-clone-game:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy Analytics Service
      command: >
        kubectl set image deployment/analytics
        analytics={{ ecr_registry }}/kahoot-clone-analytics:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Deploy Frontend
      command: >
        kubectl set image deployment/frontend
        frontend={{ ecr_registry }}/kahoot-clone-frontend:{{ build_version }}
        -n {{ namespace }}
      ignore_errors: yes
    
    - name: Wait for deployments to be ready
      command: kubectl rollout status deployment --all -n {{ namespace }} --timeout=5m
      ignore_errors: yes
    
    - name: Get pod status
      command: kubectl get pods -n {{ namespace }}
      register: pods
    
    - name: Display pod status
      debug:
        var: pods.stdout_lines
    
    - name: Get services
      command: kubectl get svc -n {{ namespace }}
      register: services
    
    - name: Display services
      debug:
        var: services.stdout_lines
