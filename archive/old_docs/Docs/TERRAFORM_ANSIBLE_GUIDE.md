# Terraform + Ansible Integration Guide

## ğŸ¯ Overview

This project uses **Terraform for infrastructure provisioning** and **Ansible for configuration management**, combining the best of both tools:

- **Terraform**: Create AWS infrastructure (VPC, EC2, ECR, IAM)
- **Ansible**: Configure servers (install Jenkins, setup K8s, deploy apps)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Deployment Flow                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Terraform                                                â”‚
â”‚     â”œâ”€ Provision AWS resources                              â”‚
â”‚     â”œâ”€ Generate Ansible inventory (automatic)               â”‚
â”‚     â””â”€ Output IPs and connection details                    â”‚
â”‚                                                              â”‚
â”‚  2. Ansible (Automatically triggered)                        â”‚
â”‚     â”œâ”€ Configure Jenkins EC2                                â”‚
â”‚     â”‚  â”œâ”€ Install Docker, Jenkins, NodeJS                   â”‚
â”‚     â”‚  â”œâ”€ Install AWS CLI, kubectl, Trivy                   â”‚
â”‚     â”‚  â””â”€ Install SonarQube Scanner                         â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€ Setup Kubernetes Cluster                             â”‚
â”‚        â”œâ”€ Initialize master node                            â”‚
â”‚        â”œâ”€ Install Calico network                            â”‚
â”‚        â””â”€ Join worker nodes                                 â”‚
â”‚                                                              â”‚
â”‚  3. Manual Steps                                             â”‚
â”‚     â”œâ”€ Configure Jenkins UI                                 â”‚
â”‚     â”œâ”€ Add credentials                                      â”‚
â”‚     â”œâ”€ Create Jenkins pipeline                              â”‚
â”‚     â””â”€ Run first build                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Project Structure

```
DevOps-Kahoot-Clone/
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ ec2.tf
â”‚   â”œâ”€â”€ jenkins-infrastructure.tf
â”‚   â”œâ”€â”€ k8s-cluster.tf
â”‚   â”œâ”€â”€ ecr.tf
â”‚   â”œâ”€â”€ iam-ecr.tf
â”‚   â”œâ”€â”€ ansible-integration.tf      # â† Ansible integration
â”‚   â”œâ”€â”€ ansible-inventory.tpl       # â† Inventory template
â”‚   â””â”€â”€ outputs.tf                  # â† Updated with Ansible inventory
â”‚
â”œâ”€â”€ ansible/
â”‚   â”œâ”€â”€ inventory/
â”‚   â”‚   â”œâ”€â”€ hosts.template          # Template file
â”‚   â”‚   â””â”€â”€ hosts                   # â† Auto-generated by Terraform
â”‚   â”‚
â”‚   â”œâ”€â”€ playbooks/
â”‚   â”‚   â”œâ”€â”€ jenkins-setup.yml       # â† Configure Jenkins
â”‚   â”‚   â”œâ”€â”€ k8s-setup.yml           # â† Setup Kubernetes
â”‚   â”‚   â””â”€â”€ deploy-app.yml          # â† Deploy application
â”‚   â”‚
â”‚   â””â”€â”€ roles/                      # Future: Role-based playbooks
â”‚
â”œâ”€â”€ deploy-ansible.ps1              # â† All-in-one deployment script
â””â”€â”€ deploy.ps1                      # Legacy script
```

## ğŸš€ Quick Start

### Prerequisites

**On Windows (your machine):**
```powershell
# 1. Terraform installed
terraform version  # Should be v1.5+

# 2. Ansible (via WSL2)
wsl --install Ubuntu-22.04
wsl
sudo apt update
sudo apt install -y ansible
```

### One-Command Deployment

```powershell
# Deploy everything (Terraform + Ansible)
.\deploy-ansible.ps1 -AutoApprove
```

**What this does:**
1. Provisions AWS infrastructure (15 min)
2. Generates Ansible inventory automatically
3. Configures Jenkins with Ansible (10 min)
4. Sets up K8s cluster with Ansible (15 min)
5. Displays access information

**Total time:** ~40 minutes

### Step-by-Step Deployment

```powershell
# Step 1: Provision infrastructure only
.\deploy-ansible.ps1 -Step terraform -AutoApprove

# Step 2: Configure servers with Ansible
.\deploy-ansible.ps1 -Step ansible

# Step 3: Verify deployment
.\deploy-ansible.ps1 -Step verify
```

## ğŸ”§ How It Works

### 1. Terraform Generates Ansible Inventory

**terraform/ansible-inventory.tpl:**
```hcl
[all:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=jenkins-key.pem

[jenkins]
${jenkins_ip}

[k8s_master]
${k8s_master_ip}

[k8s_workers]
%{ for ip in k8s_worker_ips ~}
${ip}
%{ endfor ~}
```

**terraform/ansible-integration.tf:**
```hcl
resource "local_file" "ansible_inventory" {
  content = templatefile("ansible-inventory.tpl", {
    jenkins_ip = aws_instance.jenkins_server.public_ip
    k8s_master_ip = aws_instance.k8s_master.public_ip
    k8s_worker_ips = aws_instance.k8s_workers[*].public_ip
  })
  filename = "../ansible/inventory/hosts"
}
```

**Generated ansible/inventory/hosts:**
```ini
[all:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=jenkins-key.pem

[jenkins]
54.123.45.67

[k8s_master]
54.123.45.68

[k8s_workers]
54.123.45.69
54.123.45.70
```

### 2. Ansible Configures Servers

#### Jenkins Setup (jenkins-setup.yml)

**Installs:**
- Docker (latest)
- Jenkins (LTS)
- NodeJS 18.x
- AWS CLI v2
- kubectl
- Trivy (vulnerability scanner)
- SonarQube Scanner

**Configuration:**
- Adds jenkins user to docker group
- Enables Docker BuildKit
- Installs Jenkins plugins (via Jenkins CLI)
- Sets up kubectl access

#### Kubernetes Setup (k8s-setup.yml)

**Master node:**
- Disables swap
- Installs containerd + kubeadm
- Initializes cluster with Calico
- Generates join command

**Worker nodes:**
- Prepares system (swap, kernel modules)
- Installs Kubernetes components
- Joins cluster automatically

**Automation:**
- Fetches kubeconfig from master
- Copies to Jenkins server
- Configures kubectl for jenkins user

### 3. Terraform Triggers Ansible (Automatic)

**terraform/ansible-integration.tf:**
```hcl
resource "null_resource" "run_ansible_jenkins" {
  depends_on = [local_file.ansible_inventory]
  
  provisioner "local-exec" {
    command = "ansible-playbook -i inventory/hosts playbooks/jenkins-setup.yml"
  }
}

resource "null_resource" "run_ansible_k8s" {
  depends_on = [local_file.ansible_inventory]
  
  provisioner "local-exec" {
    command = "ansible-playbook -i inventory/hosts playbooks/k8s-setup.yml"
  }
}
```

**Flow:**
1. Terraform creates EC2 instances
2. Terraform generates Ansible inventory
3. Terraform waits 60 seconds (EC2 initialization)
4. Terraform runs Ansible playbooks automatically
5. Ansible configures all servers

## ğŸ“– Usage Examples

### Run Only Terraform

```powershell
cd terraform
terraform init
terraform plan
terraform apply
```

### Run Only Ansible (After Terraform)

```powershell
cd ansible

# Configure Jenkins
ansible-playbook -i inventory/hosts playbooks/jenkins-setup.yml

# Setup Kubernetes
ansible-playbook -i inventory/hosts playbooks/k8s-setup.yml

# Deploy application
ansible-playbook -i inventory/hosts playbooks/deploy-app.yml \
  -e "ecr_registry=802346121373.dkr.ecr.ap-southeast-1.amazonaws.com" \
  -e "build_version=42"
```

### Manual Ansible Commands

```powershell
# Check connectivity
ansible all -i inventory/hosts -m ping

# Run ad-hoc command
ansible jenkins -i inventory/hosts -m shell -a "docker ps"

# Get system info
ansible k8s -i inventory/hosts -m setup | grep ansible_distribution

# Install package
ansible all -i inventory/hosts -m apt -a "name=htop state=present" --become
```

## ğŸ¯ Playbook Details

### jenkins-setup.yml

| Task Group | Duration | Purpose |
|------------|----------|---------|
| Docker | 2 min | Install Docker + BuildKit |
| Jenkins | 3 min | Install Jenkins LTS |
| NodeJS | 1 min | Install Node 18.x |
| AWS CLI | 2 min | Install AWS CLI v2 |
| kubectl | 30 sec | Install kubectl |
| Trivy | 1 min | Install vulnerability scanner |
| SonarQube | 1 min | Install scanner CLI |

**Total:** ~10 minutes

### k8s-setup.yml

| Task Group | Duration | Purpose |
|------------|----------|---------|
| System Prep | 2 min | Disable swap, load modules |
| Containerd | 2 min | Install container runtime |
| Kubernetes | 3 min | Install kubeadm, kubelet, kubectl |
| Master Init | 5 min | Initialize cluster + Calico |
| Worker Join | 3 min | Join workers to cluster |

**Total:** ~15 minutes

### deploy-app.yml

| Task Group | Duration | Purpose |
|------------|----------|---------|
| Namespace | 10 sec | Create/verify namespace |
| Secrets | 10 sec | Copy MongoDB secrets |
| SonarQube | 30 sec | Deploy SonarQube |
| Services | 2 min | Deploy 7 microservices |
| Verification | 30 sec | Check pod status |

**Total:** ~3 minutes

## ğŸ” Verification

### Check Ansible Inventory

```powershell
cd ansible
ansible-inventory -i inventory/hosts --list
```

### Verify Jenkins

```powershell
# SSH to Jenkins
ssh -i terraform/jenkins-key.pem ubuntu@<jenkins-ip>

# Check installations
docker --version
jenkins --version
node --version
aws --version
kubectl version --client
trivy --version
sonar-scanner --version
```

### Verify Kubernetes

```powershell
# SSH to master
ssh -i terraform/jenkins-key.pem ubuntu@<master-ip>

# Check cluster
kubectl get nodes
kubectl get pods --all-namespaces
kubectl cluster-info
```

## ğŸ› Troubleshooting

### Ansible Connection Issues

```powershell
# Test connectivity
ansible all -i inventory/hosts -m ping

# If fails, check:
# 1. SSH key permissions
icacls terraform\jenkins-key.pem

# 2. Security group allows SSH
# 3. EC2 instances are running
```

### Ansible Playbook Fails

```powershell
# Run with verbose output
ansible-playbook -i inventory/hosts playbooks/jenkins-setup.yml -vvv

# Run specific task
ansible-playbook -i inventory/hosts playbooks/jenkins-setup.yml --start-at-task="Install Docker"

# Check syntax
ansible-playbook --syntax-check playbooks/jenkins-setup.yml
```

### Kubernetes Join Fails

```bash
# On master node
sudo kubeadm token create --print-join-command

# On worker node
sudo kubeadm reset
sudo <paste-join-command>
```

### Jenkins Not Accessible

```bash
# Check Jenkins status
sudo systemctl status jenkins

# Check logs
sudo journalctl -u jenkins -f

# Restart Jenkins
sudo systemctl restart jenkins
```

## âš™ï¸ Configuration

### Customize Jenkins Plugins

Edit `ansible/playbooks/jenkins-setup.yml`:

```yaml
jenkins_plugins:
  - git
  - workflow-aggregator
  - docker-workflow
  - kubernetes
  - blueocean
  - your-plugin-here  # â† Add your plugin
```

### Change Kubernetes Version

Edit `ansible/playbooks/k8s-setup.yml`:

```yaml
vars:
  k8s_version: "1.29"  # Changed from 1.28
```

### Use Different SSH Key

Edit `ansible/inventory/hosts.template`:

```ini
[all:vars]
ansible_ssh_private_key_file=../terraform/your-key.pem  # â† Change here
```

## ğŸ“Š Resource Usage

### Ansible Control Node (Your PC)
- Disk: < 100 MB (Ansible binaries)
- Memory: < 500 MB during execution
- Network: Minimal (SSH connections only)

### Target Nodes

**Jenkins EC2:**
- Before Ansible: 0 GB used
- After Ansible: ~5 GB used (Docker, Jenkins, tools)

**K8s Nodes:**
- Before Ansible: 0 GB used
- After Ansible: ~3 GB used per node (containerd, K8s)

## ğŸ¯ Best Practices

1. **Always use Terraform first**
   - Creates infrastructure
   - Generates inventory automatically

2. **Check inventory before running Ansible**
   ```powershell
   cat ansible/inventory/hosts
   ```

3. **Use tags for selective runs**
   ```powershell
   ansible-playbook playbooks/jenkins-setup.yml --tags docker
   ```

4. **Test in dry-run mode**
   ```powershell
   ansible-playbook playbooks/jenkins-setup.yml --check
   ```

5. **Keep playbooks idempotent**
   - Ansible playbooks can be run multiple times
   - Won't break if run again

## ğŸ“š Related Documentation

- [Ansible Playbooks](ansible/playbooks/) - All automation scripts
- [Terraform Modules](terraform/) - Infrastructure code
- [EC2_RESOURCE_ANALYSIS.md](EC2_RESOURCE_ANALYSIS.md) - Resource requirements
- [SONARQUBE_ARCHITECTURE.md](SONARQUBE_ARCHITECTURE.md) - SonarQube setup

## ğŸš€ Next Steps

1. **Run deployment:**
   ```powershell
   .\deploy-ansible.ps1 -AutoApprove
   ```

2. **Access Jenkins:**
   - Get URL from output
   - Get initial password from Jenkins server

3. **Configure Jenkins:**
   - Add AWS ECR credentials
   - Add SonarQube token
   - Create pipeline

4. **Deploy SonarQube:**
   ```bash
   kubectl apply -f k8s/sonarqube-deployment.yaml
   ```

5. **Run first build:**
   - Trigger pipeline in Jenkins
   - Watch logs for any issues
