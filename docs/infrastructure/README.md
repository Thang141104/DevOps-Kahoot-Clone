# Enterprise Infrastructure Guide

## Architecture Overview

This project uses a **modular, environment-based infrastructure** following industry best practices:

```
infrastructure/
├── terraform/
│ ├── modules/ # Reusable Terraform modules
│ │ ├── networking/ # VPC, Subnets, NAT Gateway
│ │ ├── security/ # Security Groups, IAM
│ │ ├── compute/
│ │ │ ├── jenkins/ # Jenkins EC2 instance
│ │ │ └── kubernetes/ # K8s cluster (master + workers)
│ │ └── storage/
│ │ └── ecr/ # Container registry
│ │
│ └── environments/ # Environment-specific configurations
│ ├── dev/ # Development environment
│ ├── staging/ # Staging environment
│ └── prod/ # Production environment
│
├── ansible/
│ ├── roles/ # Ansible roles
│ │ ├── common/ # Common system configuration
│ │ ├── docker/ # Docker installation & config
│ │ ├── jenkins/ # Jenkins setup
│ │ └── kubernetes/ # K8s cluster setup
│ │
│ ├── group_vars/ # Group-specific variables
│ ├── host_vars/ # Host-specific variables
│ ├── inventory/ # Dynamic inventory (generated by Terraform)
│ ├── site.yml # Main playbook
│ └── ansible.cfg # Ansible configuration
│
└── scripts/
    └── deploy.ps1 # Automated deployment script
```

## Key Features

### Terraform Modules
- **Reusable**: Each module can be used across environments
- **Composable**: Mix and match modules as needed
- **Testable**: Modules can be tested independently
- **Versioned**: Use specific module versions

### Multi-Environment Support
- **dev**: Development environment (smaller instances, minimal HA)
- **staging**: Pre-production environment (production-like)
- **prod**: Production environment (HA, monitoring, backups)

### Ansible Roles
- **Idempotent**: Can be run multiple times safely
- **Modular**: Each role has a single responsibility
- **Parameterized**: Easily customizable via variables
- **Tagged**: Run specific tasks with tags

## Quick Start

### Prerequisites

**Windows:**
```powershell
# Install Terraform
choco install terraform

# Install AWS CLI
choco install awscli

# Install WSL2 with Ubuntu
wsl --install Ubuntu-22.04
```

**WSL (Ubuntu):**
```bash
# Install Ansible
sudo apt update
sudo apt install -y ansible

# Install Python pip
sudo apt install -y python3-pip

# Install Ansible collections
ansible-galaxy collection install community.general
```

### 1. Configure AWS Credentials

```powershell
# Configure AWS CLI
aws configure
```

### 2. Generate SSH Key

```bash
# In WSL
ssh-keygen -t rsa -b 4096 -f ~/.ssh/kahoot-prod -N ""
```

### 3. Configure Terraform Variables

```powershell
# Copy example file
cd infrastructure/terraform/environments/prod
copy terraform.tfvars.example terraform.tfvars

# Edit terraform.tfvars
notepad terraform.tfvars
```

**Required variables:**
```hcl
aws_access_key = "YOUR_AWS_ACCESS_KEY"
aws_secret_key = "YOUR_AWS_SECRET_KEY"
ssh_public_key = "ssh-rsa AAAAB3... your-email@example.com"
```

### 4. Deploy Infrastructure

```powershell
# Deploy everything
.\infrastructure\scripts\deploy.ps1 -Environment prod -AutoApprove

# Or step-by-step
.\infrastructure\scripts\deploy.ps1 -Environment prod -Action terraform
.\infrastructure\scripts\deploy.ps1 -Environment prod -Action ansible
```

## Detailed Usage

### Terraform Commands

```powershell
cd infrastructure/terraform/environments/prod

# Initialize
terraform init

# Plan
terraform plan

# Apply
terraform apply

# Destroy
terraform destroy

# View outputs
terraform output

# View specific output
terraform output jenkins_public_ip
```

### Ansible Commands

```bash
# In WSL
cd infrastructure/ansible

# Run full playbook
ansible-playbook -i inventory/hosts site.yml

# Run specific role
ansible-playbook -i inventory/hosts site.yml --tags docker

# Dry run
ansible-playbook -i inventory/hosts site.yml --check

# Verbose mode
ansible-playbook -i inventory/hosts site.yml -vvv

# Run on specific hosts
ansible-playbook -i inventory/hosts site.yml --limit jenkins
```

### Deployment Script Options

```powershell
# Deploy to specific environment
.\scripts\deploy.ps1 -Environment staging

# Terraform only
.\scripts\deploy.ps1 -Action terraform

# Ansible only
.\scripts\deploy.ps1 -Action ansible

# Verification only
.\scripts\deploy.ps1 -Action verify

# Destroy infrastructure
.\scripts\deploy.ps1 -Action destroy -AutoApprove

# Skip Ansible
.\scripts\deploy.ps1 -SkipAnsible

# Verbose mode
.\scripts\deploy.ps1 -Verbose
```

## Module Configuration

### Networking Module

**Purpose:** Creates VPC, subnets, internet gateway, NAT gateway

**Variables:**
```hcl
vpc_cidr = "10.0.0.0/16"
public_subnet_cidrs = ["10.0.1.0/24", "10.0.2.0/24"]
private_subnet_cidrs = ["10.0.11.0/24", "10.0.12.0/24"]
enable_nat_gateway = false # Set true for private subnet internet access
```

**Outputs:**
- `vpc_id`
- `public_subnet_ids`
- `private_subnet_ids`

### Security Module

**Purpose:** Security groups for Jenkins and K8s

**Variables:**
```hcl
jenkins_ingress_rules = [
  { description = "SSH", from_port = 22, to_port = 22, protocol = "tcp", cidr_blocks = ["0.0.0.0/0"] },
  { description = "Jenkins", from_port = 8080, to_port = 8080, protocol = "tcp", cidr_blocks = ["0.0.0.0/0"] }
]
```

### ECR Module

**Purpose:** Container registry for Docker images

**Variables:**
```hcl
repository_names = ["gateway", "auth", "user", "quiz", "game", "analytics", "frontend"]
scan_on_push = true
lifecycle_keep_count = 30
```

### Jenkins Module

**Purpose:** Jenkins CI/CD server

**Variables:**
```hcl
instance_type = "t3.medium"
root_volume_size = 30
enable_elastic_ip = true
```

### Kubernetes Module

**Purpose:** K8s cluster (1 master + N workers)

**Variables:**
```hcl
master_instance_type = "t3.medium"
worker_count = 2
worker_instance_type = "t3.medium"
```

## Ansible Roles

### Common Role

**Tasks:**
- Update system packages
- Install essential utilities
- Configure timezone and NTP
- Set sysctl parameters

**Variables:**
```yaml
common_timezone: "Asia/Ho_Chi_Minh"
common_packages: [curl, wget, git, vim, htop]
```

### Docker Role

**Tasks:**
- Install Docker CE
- Configure Docker daemon
- Add users to docker group
- Enable BuildKit

**Variables:**
```yaml
docker_users: [ubuntu, jenkins]
docker_buildkit_enabled: true
```

### Jenkins Role

**Tasks:**
- Install Java 17
- Install Jenkins
- Install Node.js 18
- Install AWS CLI
- Install kubectl
- Install Trivy
- Install SonarQube Scanner

**Variables:**
```yaml
jenkins_port: 8080
jenkins_java_opts: "-Xmx2048m"
```

### Kubernetes Role

**Tasks:**
- Disable swap
- Install containerd
- Install kubeadm, kubelet, kubectl
- Initialize master node
- Join worker nodes
- Install Calico network

**Variables:**
```yaml
k8s_version: "1.28"
k8s_pod_network_cidr: "192.168.0.0/16"
```

## Multi-Environment Strategy

### Development (dev)

**Use case:** Testing infrastructure changes

**Configuration:**
```hcl
jenkins_instance_type = "t3.small"
k8s_worker_count = 1
k8s_worker_instance_type = "t3.small"
enable_vpc_flow_logs = false
```

**Cost:** ~$30/month

### Staging (staging)

**Use case:** Pre-production testing

**Configuration:**
```hcl
jenkins_instance_type = "t3.medium"
k8s_worker_count = 2
k8s_worker_instance_type = "t3.medium"
enable_vpc_flow_logs = true
```

**Cost:** ~$100/month

### Production (prod)

**Use case:** Live environment

**Configuration:**
```hcl
jenkins_instance_type = "t3.large"
k8s_worker_count = 3
k8s_worker_instance_type = "t3.large"
enable_nat_gateway = true
enable_vpc_flow_logs = true
```

**Cost:** ~$200/month

## Security Best Practices

### Secrets Management

**Terraform:**
```hcl
# Use AWS Secrets Manager
variable "db_password" {
  type = string
  sensitive = true
}
```

**Ansible:**
```bash
# Use Ansible Vault
ansible-vault create group_vars/all/vault.yml
ansible-vault edit group_vars/all/vault.yml

# Run with vault
ansible-playbook site.yml --ask-vault-pass
```

### SSH Key Management

```powershell
# Generate separate keys per environment
ssh-keygen -t rsa -b 4096 -f ~/.ssh/kahoot-dev
ssh-keygen -t rsa -b 4096 -f ~/.ssh/kahoot-staging
ssh-keygen -t rsa -b 4096 -f ~/.ssh/kahoot-prod

# Restrict permissions
icacls ~/.ssh/kahoot-prod /inheritance:r /grant:r "%USERNAME%:R"
```

### IAM Policies

Follow **principle of least privilege:**
- Jenkins: ECR push/pull only
- K8s nodes: ECR pull only
- Separate IAM users per environment

## Cost Optimization

### t3.medium vs t3.large

| Instance | vCPU | RAM | Price/month | Use Case |
|----------|------|-----|-------------|----------|
| t3.small | 2 | 2 GB | ~$15 | Dev only |
| t3.medium | 2 | 4 GB | ~$30 | Staging, Prod (small) |
| t3.large | 2 | 8 GB | ~$60 | Prod (large workloads) |

### Lifecycle Policies

ECR images cleaned automatically:
- Keep last 30 tagged images
- Delete untagged images after 7 days

### Spot Instances (Advanced)

For non-critical environments:
```hcl
lifecycle {
  create_before_destroy = true
}

resource "aws_spot_instance_request" "jenkins" {
  # ... save 70% cost
}
```

## Troubleshooting

### Terraform Errors

**Error:** "Error locking state"
```powershell
# Remove lock
terraform force-unlock <LOCK_ID>
```

**Error:** "Resource already exists"
```powershell
# Import existing resource
terraform import aws_instance.jenkins i-1234567890abcdef0
```

### Ansible Errors

**Error:** "Permission denied (publickey)"
```bash
# Check SSH key
ssh -i ~/.ssh/kahoot-prod ubuntu@<IP>

# Fix permissions
chmod 600 ~/.ssh/kahoot-prod
```

**Error:** "Failed to connect to host"
```bash
# Test connectivity
ansible all -i inventory/hosts -m ping

# Check inventory
cat inventory/hosts
```

### Deployment Script Errors

**Error:** "Terraform not found"
```powershell
# Add to PATH
$env:PATH += ";C:\Program Files\Terraform"
```

**Error:** "Ansible not found in WSL"
```bash
# Install in WSL
sudo apt install ansible
```

## Additional Resources

- [Terraform Modules Documentation](modules/README.md)
- [Ansible Roles Documentation](../ansible/roles/README.md)
- [Environment Configuration Guide](environments/README.md)
- [Security Hardening Guide](../docs/SECURITY.md)
- [Cost Optimization Guide](../docs/COST_OPTIMIZATION.md)

## Next Steps

1. **Setup Remote State:**
   ```bash
   # Create S3 bucket for state
   aws s3 mb s3://kahoot-clone-terraform-state-prod

   # Enable versioning
   aws s3api put-bucket-versioning \
     --bucket kahoot-clone-terraform-state-prod \
     --versioning-configuration Status=Enabled
   ```

2. **Enable CI/CD:**
   - Configure GitHub Actions / GitLab CI
   - Automatic terraform plan on PR
   - Automatic deployment on merge

3. **Add Monitoring:**
   - Prometheus + Grafana
   - CloudWatch alerts
   - ELK stack for logs

4. **Implement Backup:**
   - Automated EBS snapshots
   - etcd backups for K8s
   - Database backups

---

**Need help?** Check [TROUBLESHOOTING.md](../docs/TROUBLESHOOTING.md) or create an issue.
